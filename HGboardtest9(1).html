<!-- Standard boilerplate to start hangouts.  Without these, your Hangout will not start. -->
<script src="//hangoutsapi.talkgadget.google.com/talkgadget/apps/gadgets/js/rpc.js"></script>
<script src="//hangoutsapi.talkgadget.google.com/hangouts/api/hangout.js?v=1.4"></script>
<script src="//plus.google.com/hangouts/_/api/v1/hangout.js"></script>
<script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HangoutBoardTest8</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <style type="text/css">
        <!--
        body {
            background-color: #181818;
            height: 10%;
        }
        .pointer {
            cursor: pointer;
        }
        .openhand {
            cursor: url(https://mail.google.com/mail/images/2/openhand.cur),default!important;
        }
        .closedhand {
            cursor: url(https://mail.google.com/mail/images/2/closedhand.cur),deafult!important;
        }
        .button {
            border-radius: 3px;
            -moz-border-radius: 3px;
            background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#ddd));
            background: -moz-linear-gradient(top, #fff, #ddd);  
            border: 1px solid #bbb;
        }
        .button:active {
            background: -webkit-gradient(linear, left top, left bottom, from(#aaa), to(#333)); 
            background: -moz-linear-gradient(bottom, #ddd, #aaa); }
        -->
        .canvasbutton {
            -webkit-animation-delay: 0s;
            -webkit-animation-direction: normal;
            -webkit-animation-duration: 0s;
            -webkit-animation-fill-mode: none;
            -webkit-animation-iteration-count: 1;
            -webkit-animation-name: none;
            -webkit-animation-play-state: running;
            -webkit-animation-timing-function: ease;
            -webkit-app-region: no-drag;
            -webkit-appearance: none;
            -webkit-backface-visibility: visible;
            -webkit-background-clip: border-box;
            -webkit-background-composite: source-over;
            -webkit-background-origin: padding-box;
            -webkit-background-size: auto;
            -webkit-border-fit: border;
            -webkit-border-horizontal-spacing: 0px;
            -webkit-border-image: none;
            -webkit-border-vertical-spacing: 0px;
            -webkit-box-align: stretch;
            -webkit-box-decoration-break: slice;
            -webkit-box-direction: normal;
            -webkit-box-flex: 0;
            -webkit-box-flex-group: 1;
            -webkit-box-lines: single;
            -webkit-box-ordinal-group: 1;
            -webkit-box-orient: horizontal;
            -webkit-box-pack: start;
            -webkit-box-reflect: none;
            -webkit-box-shadow: none;
            -webkit-clip-path: none;
            -webkit-column-break-after: auto;
            -webkit-column-break-before: auto;
            -webkit-column-break-inside: auto;
            -webkit-column-count: auto;
            -webkit-column-gap: normal;
            -webkit-column-rule-color: white;
            -webkit-column-rule-style: none;
            -webkit-column-rule-width: 0px;
            -webkit-column-span: none;
            -webkit-column-width: auto;
            -webkit-filter: none;
            -webkit-font-smoothing: antialiased;
            -webkit-highlight: none;
            -webkit-hyphenate-character: auto;
            -webkit-line-box-contain: block inline replaced;
            -webkit-line-break: auto;
            -webkit-line-clamp: none;
            -webkit-locale: it;
            -webkit-margin-after-collapse: collapse;
            -webkit-margin-before-collapse: collapse;
            -webkit-mask-box-image: none;
            -webkit-mask-box-image-outset: 0px;
            -webkit-mask-box-image-repeat: stretch;
            -webkit-mask-box-image-slice: 0 fill;
            -webkit-mask-box-image-source: none;
            -webkit-mask-box-image-width: auto;
            -webkit-mask-clip: border-box;
            -webkit-mask-composite: source-over;
            -webkit-mask-image: none;
            -webkit-mask-origin: border-box;
            -webkit-mask-position: 0% 0%;
            -webkit-mask-repeat: repeat;
            -webkit-mask-size: auto;
            -webkit-perspective: none;
            -webkit-perspective-origin: 99.5px 19px;
            -webkit-print-color-adjust: economy;
            -webkit-rtl-ordering: logical;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.180392);
            -webkit-text-combine: none;
            -webkit-text-decorations-in-effect: none;
            -webkit-text-emphasis-color: white;
            -webkit-text-emphasis-position: over;
            -webkit-text-emphasis-style: none;
            -webkit-text-fill-color: white;
            -webkit-text-orientation: vertical-right;
            -webkit-text-security: none;
            -webkit-text-stroke-color: white;
            -webkit-text-stroke-width: 0px;
            -webkit-transform: none;
            -webkit-transform-origin: 99.5px 19px;
            -webkit-transform-style: flat;
            -webkit-transition-delay: 0s;
            -webkit-transition-duration: 0s;
            -webkit-transition-property: all;
            -webkit-transition-timing-function: ease;
            -webkit-user-drag: auto;
            -webkit-user-modify: read-only;
            -webkit-user-select: none;
            -webkit-writing-mode: horizontal-tb;
            align-content: stretch;
            align-items: stretch;
            align-self: stretch;
            alignment-baseline: auto;
            backface-visibility: visible;
            background-attachment: scroll;
            background-blend-mode: normal;
            background-clip: border-box;
            background-color: #49AFCD;
            background-image: -webkit-linear-gradient(top, transparent, transparent);
            background-origin: padding-box;
            background-position: 0% 0%;
            background-repeat: repeat;
            background-size: auto;
            baseline-shift: baseline;
            border-bottom-color: rgba(0, 0, 0, 0.14902);
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
            border-bottom-style: solid;
            border-bottom-width: 1px;
            border-collapse: separate;
            border-image-outset: 0px;
            border-image-repeat: stretch;
            border-image-slice: 100%;
            border-image-source: none;
            border-image-width: 1;
            border-left-color: rgba(0, 0, 0, 0.14902);
            border-left-style: solid;
            border-left-width: 1px;
            border-right-color: rgba(0, 0, 0, 0.14902);
            border-right-style: solid;
            border-right-width: 1px;
            border-top-color: rgba(0, 0, 0, 0.14902);
            border-top-left-radius: 2px;
            border-top-right-radius: 2px;
            border-top-style: solid;
            border-top-width: 1px;
            bottom: auto;
            box-shadow: none;
            box-sizing: content-box;
            buffered-rendering: auto;
            caption-side: top;
            clear: none;
            clip: auto;
            clip-path: none;
            clip-rule: nonzero;
            color: white;
            color-interpolation: srgb;
            color-interpolation-filters: linearrgb;
            color-rendering: auto;
            cursor: default;
            direction: ltr;
            display: inline-block;
            dominant-baseline: auto;
            empty-cells: show;
            fill: rgb(0, 0, 0);
            fill-opacity: 1;
            fill-rule: nonzero;
            filter: none;
            flex-basis: auto;
            flex-direction: row;
            flex-grow: 0;
            flex-shrink: 1;
            flex-wrap: nowrap;
            float: none;
            flood-color: rgb(0, 0, 0);
            flood-opacity: 1;
            font-family: Arial;
            font-kerning: auto;
            font-size: 14px;
            font-style: normal;
            font-variant: normal;
            font-variant-ligatures: normal;
            font-weight: normal;
            glyph-orientation-horizontal: 0deg;
            glyph-orientation-vertical: auto;            
            image-rendering: auto;
            justify-content: flex-start;
            left: auto;
            letter-spacing: normal;
            lighting-color: rgb(255, 255, 255);
            line-height: 28px;
            list-style-image: none;
            list-style-position: outside;
            list-style-type: disc;             
            margin: 2px; 
            float: left;
            height: 35px;
            marker-end: none;
            marker-mid: none;
            marker-start: none;
            mask: none;
            mask-type: luminance;
            max-height: none;
            max-width: none;
            min-height: 0px;
            min-width: 54px;
            object-fit: fill;
            object-position: 50% 50%;
            opacity: 1;
            order: 0;
            orphans: auto;
            outline-color: white;
            outline-offset: 0px;
            outline-style: none;
            outline-width: 0px;
            overflow-wrap: normal;
            overflow-x: visible;
            overflow-y: visible;
            padding: 0px;
            page-break-after: auto;
            page-break-before: auto;
            page-break-inside: auto;
            paint-order: fill stroke markers;
            perspective: none;
            perspective-origin: 99.5px 19px;
            pointer-events: auto;
            position: relative;
            resize: none;
            right: auto;
            shape-rendering: auto;
            speak: normal;
            stop-color: rgb(0, 0, 0);
            stop-opacity: 1;
            stroke: none;
            stroke-dasharray: none;
            stroke-dashoffset: 0;
            stroke-linecap: butt;
            stroke-linejoin: miter;
            stroke-miterlimit: 4;
            stroke-opacity: 1;
            stroke-width: 1;
            tab-size: 8;
            table-layout: auto;
            text-align: center;
            text-anchor: start;
            text-decoration: none solid rgb(64, 64, 64);
            text-indent: 0px;
            text-overflow: clip;
            text-rendering: auto;
            text-shadow: none;
            text-transform: none;
            top: auto;
            touch-action: auto;
            transform: none;
            transform-origin: 99.5px 19px;
            transform-style: flat;
            transition-delay: 0s;
            transition-duration: 0s;
            transition-property: all;
            transition-timing-function: ease;
            unicode-bidi: normal;
            vector-effect: none;
            vertical-align: baseline;
            visibility: visible;
            white-space: nowrap;
            widows: auto;
            width: 177px;
            will-change: auto;
            word-break: normal;
            word-spacing: 0px;
            word-wrap: normal;
            writing-mode: lr-tb;
            z-index: auto;
            zoom: 1;
        }
        .highlightcanvasbutton {
            background-color:#4c66a4;
        }
        .canvasbutton:hover {
            background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #4c66a4), color-stop(1, #4c66a4) );
            background:-moz-linear-gradient( center top, #4c66a4 5%, #4c66a4 100% );
            filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#4c66a4', endColorstr='#4c66a4');
            background-color:#4c66a4;
            cursor: pointer;
        }.canvasbutton:active {
            position:relative;
            top:1px;
        }
        .formcontainer{
            background-color:#bddbfa;            
            border:1px solid #000;
            position:absolute;            
            border-radius:4px;
            overflow:auto;
            box-shadow:0 0 5px #000
        }
    </style>
</head>
<body id="body" style="padding: 10px">

    <div class="modal fade" id="newFormModal" tabindex="-1" role="dialog" aria-labelledby="newFormModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 class="modal-title">New Form</h4>
                </div>
                <div class="modal-body" >
                    <form role="form" id="newCreateForm">
          
                        <div class="form-group">
                            <label for="formTitleInput">Form Title:</label>
                            <input type="text" class="form-control" id="formTitleInput" name=formTitle" placeholder="Form Title" required>
                        </div>


                        <button type="submit" id="formSubmit" class="btn btn-default hidden">Submit</button>
                        <div class="alert alert-warning hidden" id="formValidationWarning"></div>
                        <div class="alert alert-danger hidden" id="formServerAlert">Server cannot be reached, try again later.</div>
                    </form>
                    <form role="form" id="newQuestionForm" class="hidden">
                        <div class="form-group">
                            <input type="hidden" class="form-control" id="formIdInput" name="formId"/>
                        </div>

                        <select class="form-control" id="questionSetting" name="setting">
                            <option selected="selected">Multiple Options</option>
                            <option >Open Awnser</option>
                        </select>

                        <div class="form-group">
                            <label for="questionInput">Question</label>
                            <input type="text" class="form-control" id="questionInput" name="question" placeholder="Question" >
                        </div>
                        <div class="form-group" id="Checkbox">
                            <label for="choisesInput">Choises</label>
                            <input type="text" class="form-control"  id="choisesInput" name="choises">
                            <p class="help-block">Separate by <b>;</b> ( Example: yes;no;maybe )</p>

                            <button type="submit" id="questionSubmit" class="btn btn-default hidden">Submit</button>
                            <div class="alert alert-warning hidden" id="questionValidationWarning"></div>
                            <div class="alert alert-danger hidden" id="questionServerAlert">Server cannot be reached, try again later.</div>
                        </div> 

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" id="closeFormButton">Close</button>
                    <button type="button" class="btn btn-primary" id="createFormButton">Create</button>
                    <button type="button" class="btn btn-primary hidden" id="createQuestionButton">Next Question</button>
                    <button type="button" class="btn btn-primary hidden" id="endQuestionButton">End Creation</button>
                    <button  type="button" id="AuthorizeApp2" class="btn btn-primary btn-sm app2"><span class="glyphicon glyphicon-cog"></span>Get Authorization</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->    
    <div class="modal fade" id="compileFormModal" tabindex="-1" role="dialog" aria-labelledby="compileFormModal" aria-hidden="true" >
        <div class="modal-dialog" style="width:800">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 class="modal-title">Compile Form</h4>
                </div>
                <div id="embedForm" class="modal-body"  >
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->  
      <div class="modal fade" id="resultFormModal" tabindex="-1" role="dialog" aria-labelledby="compileFormModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 class="modal-title"> Form Results</h4>
                </div>
                <div id="resultBody" class="modal-body" >
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->  

   <div class="modal fade" id="codeModal" tabindex="-1" role="dialog" aria-labelledby="compileFormModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">

                    <h4 class="modal-title"> Code Check</h4>
                </div>
                <div class="modal-body" >
                    <form role="form" id="codeForm">
          
                        <div class="form-group">
                            <label for="formTitleInput">Insert Code Here</label>
                            <input type="text" class="form-control" id="formTitleInput" name=formTitle" placeholder="code" required>
                        </div>


                        <button type="submit" id="formSubmit" class="btn btn-default hidden">Submit</button>
                        <div class="alert alert-warning hidden" id="formValidationWarning"></div>
                        <div class="alert alert-danger hidden" id="formServerAlert">Server cannot be reached, try again later.</div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="codeButton">Save Code</button>

                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->  

    <BR>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

    <BR>
    <div id="controls" style="width: 1200; overflow: hidden;">
        <button class="canvasbutton" id="newPost" style="width: 110; margin-left: 0px;">
            <span class="glyphicon glyphicon-plus"></span> New Post-it
        </button>
        <button class="canvasbutton" id="line" style="width: 95;">
            <span class="glyphicon glyphicon-pencil"></span> New Line
        </button>        
        <button class="canvasbutton" id="delete" style="width: 90;">
            <span class="glyphicon glyphicon-remove-sign"></span> Delete
        </button>
        <button class="canvasbutton" id="matrix" style="width: 90;">
            <span class="glyphicon glyphicon-th"></span> Matrix
        </button>
        <button class="canvasbutton" id="resize" style="width: 90;">
            <span class="glyphicon glyphicon-plus-sign"></span> Resize
        </button>
        <button class="canvasbutton" id="undo" style="float: right; width: 120;" onclick="cs.undo()">
            <span class="glyphicon glyphicon-refresh"></span> Undo Clear
        </button>
        <button class="canvasbutton" id="clear" style="float: right; width: 120;" onclick="cs.clearState()">
            <span class="glyphicon glyphicon-unchecked"></span> Clear Board
        </button>   
	
        <a id="download" class="canvasbutton" style="width:150"> Download Board Image </a>
        <button class="canvasbutton" id="end" style="width: 90;">
            End Table
        </button>
    </div>
    <style>
        .canvas {
            position:absolute; 
            left:0px;
            top:0px;        
        }
    </style>   
    <div id="InfoWrapper"></div>
    <table  id="table" width="100%">
        <tr>
            <td width="800">
                <div id ="externalDiv" style="position:relative">
                    <div id = "boardDiv" style="position: relative; width: 800; height: 500; overflow: scroll; float: left;">
                        <canvas id="shadowCanvas" class="canvas" style="z-index: 4;" width="1200" height="800">
                        </canvas>
                        <canvas id="postItCanvas" class="canvas" style="z-index: 3;" width="1200" height="800">
                        </canvas>    
                        <canvas id="pencilCanvas" class="canvas" style="z-index: 2;" width="1200" height="800">
                        </canvas>
                        <canvas id="matrixCanvas" class="canvas" style="z-index: 1; background-color: white;" width="1200" height="800">
                        </canvas> 
                        <canvas id="imageCanvas" class="canvas" style="z-index: 0; background-color: white;" width="1200" height="800">
                        </canvas> 
                    </div>
                    <div id="InputsWrapper" style="position: absolute; z-index: 4; left: 240px; top: 180px"></div>
                </div>  
            </td>
            <td>
 <!--<div id="formContainer" style="background-color:white;height:500;width:500">

        <div id="forms" style="border:solid; height:450;width:500">

        </div>
        <div id="masterSection" style="text-align:center">
             <p style="height:4;width:200;float:left"></div>
            <button  data-toggle="modal" data-target="#newFormModal" type="button" id="embedActivity" class="canvasbutton" >Start Form</button>
            <div style="height:45;width:200"></div>
        </div>
    </div>-->
            </td>         
        </tr>
    </table>
       
 
   
    <script>
        window.tableEnded = false;
        window.formAdded = false;
        window.cs = new CanvasState(document.getElementById('postItCanvas'), document.getElementById('pencilCanvas'), document.getElementById('shadowCanvas'),
        document.getElementById('matrixCanvas'), document.getElementById('imageCanvas'));
        formIds = [];
        var upvoted = [];
        var downvoted = [];
        var resizeFactor = 1;
        var latestResizeFactor = 1;
        var defaultCanvasWidth = 1200;
        var defaultCanvasHeight = 800;
        var n = 0;
        var currentPostIt = null;
        var currentTitle = null;
        var color = null;
        var mioIdStart = 0;
        var mioId = 0;
        var mieiPost = [];
        var formText = "";
        var inputReady = false;
        var InfoWrapper = $("#InfoWrapper");
        var InputsWrapper = $("#InputsWrapper");
        var newPost = $('#newPost');
        var select = $('#select');
        var newLine = $('#line');
        var elDelete = $('#delete');
        var newMatrix = $('#matrix');
        var resize = $('#resize');
        $(newPost).click(function () {
            if (inputReady) {
                $(".formcontainer").remove();
                inputReady = false;
            }
            inputReady = true;
            $(InputsWrapper).append('<div class="formcontainer">' + '<button class="removeclass0" style="float: right">x</button>' + '<br>' +
                    '<label>Add your post-it to the canvas</label>' + '<br>' +
                    '<input type="text" id="postittext" name="mytext[]" size="35" maxlength="255"' +
                    '" placeholder="Insert your post-it text here"/>' + '<button class="addclass0">Add</button>' +
                    '<select id="color" style="float: right"><option value="gold">Yellow</option><option value="#8CC43E">Lime</option>\n\
                    <option value="#F8823C">Orange</option><option value="#EB2142">Red</option>\n\
                    <option value="#425F9C">Blue</option><option value="#08233E">Dark Blue</option> </select>' + '<br>' +
                    '</div>');
            return false;
        });
        $("body").on("click", ".removeclass0", function () {
            $(this).parent('div').remove(); // To Remove Name Field        
            return false;
        });
        $("body").on("click", ".addclass0", function () {
            formText = $("#postittext").val();
            color = $("#color").val();            
            cs.setTool('newPost');
            $(this).parent('div').remove();
            return false;
        });
        $("body").on("click", ".editclass0", function () {
            currentPostIt.setText($("#postittext").val());
            currentPostIt.setFill($("#color").val());
            setShapeState(currentPostIt);
            $(this).parent('div').remove();
            return false;
        });
        $("body").on("click", ".createsectionsclass0", function () {
            var sections = parseInt($("#sectionsnumber").val());
            var sharedObjectKey = "sections";
            var sectionsStr = JSON.stringify(sections);
            var obj = {};
            obj[sharedObjectKey] = sectionsStr;
            gapi.hangout.data.submitDelta(obj);
            $(this).parent('div').remove();
            return false;
        });
        $("body").on("click", ".edittitleclass0", function () {
            currentTitle.setText($("#titletext").val());
            setTitleState(currentTitle);
            $(this).parent('div').remove();
            return false;
        });
        $("body").on("click", ".resizeclass0", function () {
            var key = "size";
            var value = ($("#size").val());
            var obj = {};
            obj[key] = value;
            gapi.hangout.data.submitDelta(obj);
            $(this).parent('div').remove();
            return false;
        });
        $(newLine).click(function () {
            if (cs.getAction() === "line") {
                cs.setDefault();               
            }
            else {
                cs.setTool('line');                
            }
        });
        $(elDelete).click(function () {
            cs.delete();
        });
        $(matrix).click(function () {
            if (inputReady) {
                $(".formcontainer").remove();
                inputReady = false;
            }
            inputReady = true;
            $(InputsWrapper).append('<div class="formcontainer">' + '<button class="removeclass0" style="float: right">x</button>' + '<br>' +
                    '<label style="width:300px;">Choose the number of canvas sections</label>' +
                    '<button class="createsectionsclass0">Create</button>' +
                    '<select id="sectionsnumber" style="float: right"><option value="2">2 Sections</option><option value="4">4 Sections</option>\n\
                    <option value="6">6 Sections</option><option value="9">9 Sections</option></select>' + '<br>' +
                    '</div>');
        });
        $(resize).click(function () {
            if (inputReady) {
                $(".formcontainer").remove();
                inputReady = false;
            }
            inputReady = true;
            $(InputsWrapper).append('<div class="formcontainer">' + '<button class="removeclass0" style="float: right">x</button>' + '<br>' +
                    '<label style="width:300px;">Resize the canvas element</label>' +
                    '<button class="resizeclass0">Resize</button>' +
                    '<select id="size" style="float: right"><option value="0.7">840x560</option>\n\
                    <option value="1">1200x800 (default)</option><option value="1.5">1800x1200</option>\n\
                    <option value="2">2400x1600</option><option value="3">3600x2400</option>\n\
                    <option value="4">4800x2400</option><option value="6">7200x4800</option></select>' + '<br>' +
                    '</div>');
            return false;
        });
        function editPostIt(shape) {
            if (inputReady) {
                $(".formcontainer").remove();
                inputReady = false;
            }
            currentPostIt = shape;
            inputReady = true;
            $(InputsWrapper).append('<div class="formcontainer">' + '<button class="removeclass0" style="float: right">x</button>' + '<br>' +
                    '<label>Edit this post-it</label>' + '<br>' + '<input type="text" id="postittext" name="mytext[]" value="' + shape.text + '" size="35" maxlength="255"' +
                    '" placeholder="Insert your post-it text here"/>' +
                    '<select id="color" style="float: right"><option value="gold">Yellow</option><option value="#8CC43E">Lime</option>\n\
                    <option value="#F8823C">Orange</option><option value="#EB2142">Red</option>\n\
                    <option value="#425F9C">Blue</option><option value="#08233E">Dark Blue</option> </select>' +
                    '<button class="editclass0">Edit</button>' + '<br>' +
                    '</div>');
            return false;
        }
        function editTitle(title) {
            if (inputReady) {
                $(".formcontainer").remove();
                inputReady = false;
            }
            currentTitle = title;
            inputReady = true;
            $(InputsWrapper).append('<div class="formcontainer">' + '<button class="removeclass0" style="float: right">x</button>' + '<br>' +
                    '<label>Insert Title here:</label>' + '<br>' + '<input type="text" id="titletext" name="mytext[]" value="' + title.text + '" size="35" maxlength="20"' +
                    '" placeholder="Title"/>' +
                    '<button class="edittitleclass0">Edit</button>' + '<br>' +
                    '</div>');
            return false;
        }
        function hasBeenUpVoted(id) {
            for (var i = 0; i < upvoted.length; i++) {
                if (upvoted[i] === id) {
                    return true;
                }
            }
            return false;
        }
        function hasBeenDownVoted(id) {
            for (var i = 0; i < downvoted.length; i++) {
                if (downvoted[i] === id) {
                    return true;
                }
            }
            return false;
        }
        gapi.hangout.onApiReady.add(function (e) { 
            if (gapi.hangout.getLocalParticipant().isBroadcaster) {
               console.log("ok");

               //var modalDiv = $('#codeModal');
               //modalDiv.find('#codeForm')[0].reset();
               //modalDiv.modal('show');
               addHangout(); 
               setTimeout(checkAuth(),3000);      
            }  else {
               $("#end").fadeOut(); 
            }
            var state = gapi.hangout.data.getState();
            updateInternalState(state.validShapes);
            updateInternalLinesState(state.validLines);            
            updateInternalCanvasStateSize(state.size);            
            updateInternalSectionsState(state.sections);
            updateInternalTitlesState(state.validTitles);
            var currentAssignment = state.idassignment;
            if (currentAssignment === undefined) {
                currentAssignment = 0;
            }
            mioIdStart = parseInt(currentAssignment) + (Math.floor((Math.random() * 10)) * 2000);
            mioId = mioIdStart;
            var newAssignment = parseInt(currentAssignment) + 20000;
            var nuovoid = JSON.stringify(newAssignment);
            gapi.hangout.data.submitDelta({"idassignment": nuovoid});
          
        });
        function Line(id, beginX, beginY, endX, endY, color) {
            this.id = id;
            this.beginX = beginX;
            this.beginY = beginY;
            this.endX = endX;
            this.endY = endY;
            this.color = color;
        }
        Line.prototype.draw = function (ctx) {
            ctx.beginPath();
            ctx.strokeStyle = this.color;
            ctx.moveTo(this.beginX * resizeFactor, this.beginY * resizeFactor);
            ctx.lineTo(this.endX * resizeFactor, this.endY * resizeFactor);
            ctx.stroke();
        };
        Line.prototype.setColor = function (color) {
            this.color = color;
        };
        Line.prototype.contains = function (mx, my) {
            return isOnLine(this.beginX * resizeFactor, this.beginY * resizeFactor,
            this.endX * resizeFactor, this.endY * resizeFactor, mx, my);
        };
        Line.prototype.tipo = function () {
            return "Line";
        };
        function isOnLine(x, y, endx, endy, px, py) {
            var d = (Math.abs((endx - x) * (y - py) - (x - px) * (endy - y))) / (Math.sqrt(Math.pow(endx - x, 2) + Math.pow(endy - y, 2)));
            var boolean = ((px >= x - 4) && (px <= endx + 4)) || ((px <= x + 4) && (px >= endx - 4));
            if (boolean && (d < 4)) {
                return true;
            }
            else {
                return false;
            }
        }
        function Shape(id, text, x, y, w, h, likes, dislikes, fill, au) {
            this.id = id;
            this.text = text || "";
            this.x = x;
            this.y = y;
            this.w = w || 220;
            this.h = h || 80;
            this.ls = likes || 0;
            this.ds = dislikes || 0;
            this.fill = fill || 'lightseagreen';
            this.au = au || 'Hidden';
        }
        Shape.prototype.draw = function (ctx) {
            var sx = this.x * resizeFactor;
            var sy = this.y * resizeFactor;
            var fontWeight = "lighter";
            var fontHeight = 13;
            var fontFamily = "Arial";
            var fontStr = fontWeight + " " + fontHeight + "px " + fontFamily;
            var agreeFontHeight = fontHeight - 4;
            var agreeFontStr = agreeFontHeight + "px " + fontFamily;
            ctx.font = fontStr;
            var ordinato = ordinaTesto(ctx, this.text, this.w - 20);
            var numeroRighe = ordinato.length;
            this.h = (3 * fontHeight) + (numeroRighe * fontHeight) + (2 * agreeFontHeight);
            ctx.fillStyle = this.fill;
            ctx.fillRect(sx, sy, this.w, this.h);
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            ctx.font = fontStr;
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'white';
            for (var i = 0; i < numeroRighe; i++) {
                ctx.strokeText(ordinato[i], (sx)
                        + (this.w / 2), sy + 26 + (i * fontHeight));
            }
            ctx.textBaseline = "middle";
            ctx.font = agreeFontStr;
            ctx.strokeText(this.au, sx + (this.w / 2), sy + 13);
            var likes = "Agree: " + this.ls;
            var dislikes = "Disagree: " + this.ds;
            ctx.strokeText(likes, (sx + (this.w / 4)),
            (sy + (this.h - 10)));
            ctx.strokeText(dislikes, (sx + (this.w / (3 / 2))),
            (sy + (this.h - 10)));
            ctx.fillRect((sx + (this.w / (5 / 2))), (sy + (this.h - 12)), 12, 4);
            ctx.fillRect((sx + (this.w / (5 / 2)) + 4), (sy + (this.h - 12) - 4), 4, 12);
            ctx.fillRect((sx + (this.w - (this.w / 6))), (sy + (this.h - 12)), 12, 4);
            ctx.strokeRect((sx + (this.w / (5 / 2))), (sy + (this.h - 12)), 12, 4);
            ctx.strokeRect((sx + (this.w / (5 / 2)) + 4), (sy + (this.h - 12) - 4), 4, 12);
            ctx.strokeRect((sx + (this.w - (this.w / 6))), (sy + (this.h - 12)), 12, 4);
        };
        Shape.prototype.tipo = function () {
            return "Shape";
        };
        Shape.prototype.setAuthor = function (a) {
            this.au = a;
        };
        Shape.prototype.setText = function (newText) {
            this.text = newText;
        };
        Shape.prototype.setFill = function (color) {
            this.fill = color;
        };
        Shape.prototype.addLike = function () {
            this.ls = this.ls + 1;
        };
        Shape.prototype.removeLike = function () {
            this.ls = this.ls - 1;
        };
        Shape.prototype.addDislike = function () {
            this.ds = this.ds + 1;
        };
        Shape.prototype.removeDislike = function () {
            this.ds = this.ds - 1;
        };
        function ordinaTesto(context, text, fitWidth) {
            fitWidth = fitWidth || 0;
            var rigaCorrente = "";
            var testoOrdinato = [];
            if (fitWidth <= 0) {
                testoOrdinato.push(text);
                return;
            }
            var words = text.split(' ');
            var i = 0;
            while (i <= (words.length - 1)) {
                var parolaCorrente = words[i] + ' ';
                var vecchiaRiga = rigaCorrente;
                rigaCorrente = rigaCorrente + parolaCorrente;
                if (context.measureText(rigaCorrente).width > fitWidth) {
                    if (vecchiaRiga === "") {
                        testoOrdinato.push(rigaCorrente);
                        rigaCorrente = "";
                        i++;
                    }
                    else {
                        testoOrdinato.push(vecchiaRiga);
                        rigaCorrente = "";
                    }
                }
                else {
                    i++;
                }
            }
            if (rigaCorrente !== "") {
                testoOrdinato.push(rigaCorrente);
            }
            return testoOrdinato;
        }
        ;
        Shape.prototype.contains = function (mx, my) {
            var sx = this.x * resizeFactor;
            var sy = this.y * resizeFactor;
            if ((sx <= mx) && (mx <= (sx + this.w)) &&
                    (sy <= my) && (my <= (sy + this.h))) {
                return true;
            }
            return false;
        };
        Shape.prototype.mouseIsOnUpVote = function (mx, my) {
            var sx = this.x * resizeFactor;
            var sy = this.y * resizeFactor;
            if (((sx + (this.w / (5 / 2))) <= mx) && (mx <= (sx + (this.w / (5 / 2)) + 12)) &&
                    ((sy + (this.h - 12) - 4) <= my) && (my <= (sy + (this.h - 12) + 8))) {
                return true;
            }
            return false;
        };
        Shape.prototype.mouseIsOnDownVote = function (mx, my) {
            var sx = this.x * resizeFactor;
            var sy = this.y * resizeFactor;
            if (((sx + (this.w - (this.w / 6))) <= mx) && (mx <= (sx + (this.w - (this.w / 6)) + 12)) &&
                    ((sy + (this.h - 12) - 4) <= my) && (my <= (sy + (this.h - 12) + 8))) {
                return true;
            }
            return false;
        };
        function Text(id, text, x, y, w) {
            this.id = id;
            this.text = text;
            this.x = x;
            this.y = y;
            this.w = w || 0;
        }
        ;
        Text.prototype.setW = function (width) {
            this.w = width;
        };
        Text.prototype.setText = function (t) {
            this.text = t;
        };
        Text.prototype.drawTitle = function (ctx) {
            console.log("Disegnando il titolo");
            ctx.font = "bold 20px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            ctx.fillStyle = 'black';
            ctx.fillText(this.text, this.x * resizeFactor, this.y * resizeFactor);
            this.setW(ctx.measureText(this.text).width);
            console.log("fatto");
        };
        Text.prototype.contains = function (mx, my) {
            var titleX = (this.x * resizeFactor);
            var titleY = (this.y * resizeFactor);
            if (((titleX - (this.w / 2)) <= mx) && (mx <= (titleX + (this.w / 2))) &&
                    (titleY <= my) && (my <= (titleY + 20))) {
                return true;
            }
            return false;
        };
        function CanvasState(canvas, pencilCanvas, shadowCanvas, matrixCanvas, imageCanvas) {
            this.canvas = canvas;
            this.ctx = this.canvas.getContext("2d");
            this.pencilCanvas = pencilCanvas;
            this.pencilCtx = this.pencilCanvas.getContext("2d");
            this.shadowCanvas = shadowCanvas;
            this.shadowCtx = this.shadowCanvas.getContext("2d");
            this.matrixCanvas = matrixCanvas;
            this.matrixCtx = this.matrixCanvas.getContext("2d");
            this.idShapes = [];
            this.shapes = [];
            this.idLines = [];
            this.lines = [];
            this.idTitles = [];
            this.titles = [];
            this.numberOfSections = 0;
            this.latestNumberOfSections = 0;
            this.valid = false;
            this.defaultColor = 'black';
            this.defaultAction = "select";
            this.action = "select";
            this.currentLine = null;
            this.selection = null;
            this.dragoffx = 0;
            this.dragoffy = 0;
            var myState = this;
            shadowCanvas.addEventListener('mouseover', function (e) {
                var action = myState.action;
                var mouse = myState.getMouse(this.canvas, e);
                var mx = mouse.x;
                var my = mouse.y;
                var shapes = myState.shapes;
                var lines = myState.lines;
                switch (action) {
                    case "line":
                        document.body.style.cursor = "crosshair";
                        break;
                    case 'newPost':
                        document.body.style.cursor = "none";
                        break;
                }
            });
            shadowCanvas.addEventListener('mouseout', function (e) {
                document.body.style.cursor = "default";
            });
            shadowCanvas.addEventListener('mousedown', function (e) {
                var mouse = myState.getMouse(this.canvas, e);
                var mx = mouse.x;
                var my = mouse.y;
                var action = myState.action;
                var shapes = myState.shapes;
                var lines = myState.lines;
                var titles = myState.titles;
                var l = shapes.length;
                switch (action) {
                    case "line":
                        beginX = mx;
                        beginY = my;
                        myState.action = 'drawLine';
                        break;
                    case "newPost":
                        myState.shadowCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                        document.body.style.cursor = "default";
                        myState.writePostIt(formText, mx, my, color);
                        myState.setDefault();
                        break;
                    case "select":
                        for (var i = shapes.length - 1; i >= 0; i--) {
                            if (shapes[i].contains(mx, my)) {
                                if (shapes[i].mouseIsOnUpVote(mx, my)) {
                                    if (hasBeenUpVoted(shapes[i].id)) {
                                        return;
                                    }
                                    else {
                                        var templ = shapes[i];
                                        templ.addLike();
                                        upvoted.push(templ.id);
                                        if (hasBeenDownVoted(templ.id)) {
                                            templ.removeDislike();
                                            var index = downvoted.indexOf(templ.id);
                                            downvoted.splice(index, 1);
                                        }
                                        setShapeLikesState(templ);
                                    }
                                }
                                else if (shapes[i].mouseIsOnDownVote(mx, my)) {
                                    if (hasBeenDownVoted(shapes[i].id)) {
                                        return;
                                    }
                                    else {
                                        var tempd = shapes[i];
                                        tempd.addDislike();
                                        downvoted.push(tempd.id);
                                        if (hasBeenUpVoted(tempd.id)) {
                                            tempd.removeLike();
                                            var index = upvoted.indexOf(tempd.id);
                                            upvoted.splice(index, 1);
                                        }
                                        setShapeLikesState(tempd);
                                    }

                                }
                                else {
                                    $("#boardDiv").removeClass("openhand");
                                    $("#boardDiv").addClass("closedhand");
                                    var mySel = shapes[i];
                                    myState.dragoffx = (mx / resizeFactor) - mySel.x;
                                    myState.dragoffy = (my / resizeFactor) - mySel.y;
                                    myState.action = 'dragging';
                                    myState.selection = mySel;
                                    myState.valid = false;
                                }
                                return;
                            }
                        }
                        for (var i = lines.length - 1; i >= 0; i--) {
                            if (lines[i].contains(mx, my)) {
                                $("#boardDiv").removeClass("openhand");
                                $("#boardDiv").addClass("closedhand");
                                var mySel = lines[i];
                                myState.selection = mySel;
                                myState.valid = false;                                
                                var id = lines[i].id;
                                var bX = lines[i].beginX * resizeFactor;
                                var bY = lines[i].beginY * resizeFactor;
                                var eX = lines[i].endX * resizeFactor;
                                var eY = lines[i].endY * resizeFactor;
                                var lunghezza = Math.sqrt(Math.pow(eX - bX, 2) + Math.pow(eY - bY, 2));
                                var distanzadabegin = Math.sqrt(Math.pow(mx - bX, 2) + Math.pow(my - bY, 2));
                                var distanzadaend = Math.sqrt(Math.pow(mx - eX, 2) + Math.pow(my - eY, 2));
                                if (distanzadabegin <= 8) {
                                    lineId = id;
                                    beginX = eX / resizeFactor;
                                    beginY = eY / resizeFactor;
                                    myState.action = 'changeLine';
                                    return;
                                }
                                else if (distanzadaend <= 8) {
                                    lineId = id;
                                    beginX = bX / resizeFactor;
                                    beginY = bY / resizeFactor;
                                    myState.action = 'changeLine';
                                    return;
                                }
                                else {
                                    lineId = id;
                                    beginX = bX / resizeFactor;
                                    beginY = bY / resizeFactor;
                                    endX = eX / resizeFactor;
                                    endY = eY / resizeFactor;
                                    currentX = mx;
                                    currentY = my;
                                    myState.action = 'dragLine';
                                    return;
                                }
                                return;
                            }
                        }
                        for (var i = 0; i < titles.length; i++) {
                            if (titles[i].contains(mx, my)) {
                                editTitle(titles[i]);
                                break;
                            }
                        }
                        break;
                }
                if (myState.selection) {
                    myState.selection = null;
                    myState.valid = false;
                }
            }, true);
            shadowCanvas.addEventListener('dblclick', function (e) {
                var action = myState.action;
                var mouse = myState.getMouse(this.canvas, e);
                var mx = mouse.x;
                var my = mouse.y;
                var shapes = myState.shapes;
                if (action === 'select') {
                    for (var i = shapes.length - 1; i >= 0; i--) {
                        if (shapes[i].contains(mx, my)) {
                            if (mieiPost.indexOf(shapes[i].id) !== -1) {
                                var mySel = shapes[i];                                
                                editPostIt(mySel);
                            }
                        }
                    }
                }
                else {
                    myState.setDefault();
                }
            }, true);
            shadowCanvas.addEventListener('mousemove', function (e) {
                var action = myState.action;
                var mouse = myState.getMouse(this.canvas, e);
                var mx = mouse.x;
                var my = mouse.y;
                var shapes = myState.shapes;
                var lines = myState.lines;
                var titles = myState.titles;
                switch (action) {
                    case 'newPost':
                        myState.shadowCtx.font = "13px Arial";
                        var testo = formText;
                        var testoOrdinato = ordinaTesto(myState.shadowCtx, testo, 200);
                        var h = (13 * 3) + (2 * 9) + (testoOrdinato.length * 13);
                        myState.shadowCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                        myState.shadowCtx.strokeStyle = 'grey';
                        myState.shadowCtx.strokeRect(mx, my, 220, h);
                        break;
                    case 'drawLine':
                        endX = mx / resizeFactor;
                        endY = my / resizeFactor;
                        var line = new Line(0, beginX, beginY, endX, endY, 'grey');
                        myState.currentLine = line;
                        myState.drawShadowLine(line);
                        myState.valid = false;
                        break;
                    case 'changeLine':
                        endX = mx / resizeFactor;
                        endY = my / resizeFactor;
                        line = new Line(lineId, beginX, beginY, endX, endY, 'grey');
                        myState.drawShadowLine(line);
                        var sel = myState.selection;
                        sel.beginX = beginX;
                        sel.beginY = beginY;
                        sel.endX = endX;
                        sel.endY = endY;
                        myState.valid = false;
                        break;
                    case 'dragLine':
                        var spostamentoX = (mx - currentX) / resizeFactor;
                        var spostamentoY = (my - currentY) / resizeFactor;
                        var line = new Line(lineId, (beginX + spostamentoX), (beginY + spostamentoY), (endX + spostamentoX), (endY + spostamentoY), 'grey');
                        var sel = myState.selection;
                        sel.beginX = beginX + spostamentoX;
                        sel.beginY = beginY + spostamentoY;
                        sel.endX = endX + spostamentoX;
                        sel.endY = endY + spostamentoY;
                        myState.drawShadowLine(line);
                        myState.valid = false;
                        break;
                    case 'dragging':
                        var sel = myState.selection;
                        sel.x = (mx / resizeFactor) - myState.dragoffx;
                        sel.y = (my / resizeFactor) - myState.dragoffy;
                        myState.valid = false;
                        break;
                    case "select":
                        for (var i = shapes.length - 1; i >= 0; i--) {
                            if (shapes[i].contains(mx, my)) {
                                if (shapes[i].mouseIsOnUpVote(mx, my) || shapes[i].mouseIsOnDownVote(mx, my)) {
                                    $("#boardDiv").removeClass("openhand");
                                    $("#boardDiv").addClass("pointer");
                                }
                                else {                                    
                                    $("#boardDiv").addClass("openhand");
                                }
                                return;
                            }
                        }
                        for (var i = lines.length - 1; i >= 0; i--) {
                            if (lines[i].contains(mx, my)) {
                                $("#boardDiv").addClass("openhand");
                                return;
                            }
                        }
                        for (var i = 0; i < titles.length; i++) {
                            if (titles[i].contains(mx, my)) {
                                // qui ci va per mettere il cursore.
                                return;
                            }
                        }
                        $("#boardDiv").removeClass("openhand");
                        $("#boardDiv").removeClass("pointer");
                        break;
                }
            }, true);
            shadowCanvas.addEventListener('mouseup', function (e) {
                var action = myState.action;
                $("#boardDiv").removeClass("closedhand");
                switch (action) {
                    case 'drawLine':
                        myState.shadowCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                        var line = myState.currentLine;
                        if (line === null) {
                            myState.action = "line";
                            break;
                        }
                        line.setColor('black');
                        myState.writeLine(line.id, line.beginX, line.beginY, line.endX, line.endY, line.color);
                        myState.currentLine = null;
                        myState.action = "line";
                        break;
                    case 'changeLine':
                    case 'dragLine':
                        myState.shadowCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                        var line = myState.selection;
                        line.setColor("black");
                        setLineState(line);
                        myState.action = "select";
                        document.body.style.cursor = 'default';
                        break;
                    case 'dragging':
                        var sel = myState.selection;
                        myState.action = "select";
                        setShapePositionState(sel);
                        break;
                }
                this.selectionColor = '#CC0000';
                this.selectionWidth = 2;
                this.interval = 30;
                setInterval(function () {
                    myState.draw();
                }, myState.interval);
            }, true);
        }
        CanvasState.prototype.setTool = function (string) {
            this.setDefault();
            switch (string) {
                case "clear":
                    this.clearState();
                    break;
                case "remove":
                    $('#delete').addClass('highlightcanvasbutton');
                    this.remove();
                    break;
                case "undo":
                    this.undo();
                    break;
                case "newPost":
                    $('#newPost').addClass('highlightcanvasbutton');
                    this.action = "newPost";
                    break;
                case "select":
                    $('#select').addClass('highlightcanvasbutton');
                    this.action = 'select';
                    break;
                case "line":
                    $('#line').addClass('highlightcanvasbutton');
                    this.action = 'line';
                    break;
            }
        };
        CanvasState.prototype.getAction = function () {
            return this.action;
        };
        CanvasState.prototype.setDefault = function () {
            this.shadowCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
            this.action = this.defaultAction;
            var el = document.getElementsByClassName('highlightcanvasbutton');
            for (var i = 0; i < el.length; i++) {
                el[i].className = "canvasbutton";
            }
            document.body.style.cursor = "default";
        };
        CanvasState.prototype.setNumberOfSections = function (number) {
            this.numberOfSections = number;
        };
        CanvasState.prototype.setIdTitles = function (ids) {
            this.idTitles = ids;
        };
        CanvasState.prototype.setTitles = function (t) {
            this.titles = t;
        };
        CanvasState.prototype.clearState = function () {
            var validTitlesStr = JSON.stringify(this.idTitles);
            var validShapes = this.idShapes;
            var validShapesStr = JSON.stringify(validShapes);
            var validLines = this.idLines;
            var validLinesStr = JSON.stringify(validLines);
            var sectionsStr = JSON.stringify(this.numberOfSections);
            gapi.hangout.data.submitDelta({'oldValidTitles': validTitlesStr, 'validTitles': '[]', 'oldSections': sectionsStr, 'sections': '0', 'oldValidShapes': validShapesStr, 'oldValidLines': validLinesStr, 'validShapes': '[]', 'validLines': '[]'});
            n = 0;
            document.getElementById("undo").disabled = false;
        };
        CanvasState.prototype.undo = function () {
            var state = gapi.hangout.data.getState();
            gapi.hangout.data.submitDelta({'oldValidShapes': '[]', 'oldValidLines': '[]', 'oldSections': 'undefined', 'oldValidTitles': '[]', 'sections': state.oldSections, 'validTitles': state.oldValidTitles, 'validShapes': state.oldValidShapes, 'validLines': state.oldValidLines});
            document.getElementById("undo").disabled = true;
        };
        CanvasState.prototype.clearPencil = function () {
            this.pencilCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
        };
        CanvasState.prototype.writePostIt = function (text, mx, my, color) {
            var id = mioId;
            var shape = new Shape(id, text, mx / resizeFactor, my / resizeFactor);
            var author = gapi.hangout.getLocalParticipant().person.displayName;
            shape.setFill(color);
            shape.setAuthor(author);
            if (id === (mioIdStart + 1999)) {
                mioId = mioIdStart;
            }
            else {
                mioId++;
            }
            this.shapes.push(shape);
            this.valid = false;
            this.idShapes.push(id);
            mieiPost.push(id);            
            addShapeToState(shape, this.idShapes);
        };
        CanvasState.prototype.writeLine = function (oldid, beginX, beginY, endX, endY, color) {
            var id = mioId;
            var line = new Line(id, beginX, beginY, endX, endY, color);
            if (id === (mioIdStart + 1999)) {
                mioId = mioIdStart;
            }
            else {
                mioId++;
            }
            this.lines.push(line);
            this.valid = false;
            this.idLines.push(id);
            addLineToState(line, this.idLines);
        };
        CanvasState.prototype.delete = function () {
            if (this.selection.tipo() === "Shape") {
                if (mieiPost.indexOf(this.selection.id) !== -1) {
                    removeShapeFromState(this.selection);
                    this.selection = null;
                }
            }
            else if (this.selection.tipo() === "Line") {
                removeLineFromState(this.selection);
                this.selection = null;
            }
        };
        CanvasState.prototype.remove = function () {
            this.action = "remove";
        };
        CanvasState.prototype.setShapes = function (s) {
            this.shapes = s;
        };
        CanvasState.prototype.setIdShapes = function (ids) {
             
            this.idShapes = ids;
        };
        CanvasState.prototype.setLines = function (l) {
            this.lines = l;
        };
        CanvasState.prototype.setIdLines = function (ids) {
            this.idLines = ids;
        };
        CanvasState.prototype.invalidate = function () {
            this.valid = false;
        };
        CanvasState.prototype.drawShadowLine = function (line) {
            this.shadowCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
            line.draw(this.shadowCtx);
        };
        CanvasState.prototype.draw = function () {
            if (!this.valid) {
                this.ctx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                this.pencilCtx.clearRect(0, 0, pencilCanvas.width, pencilCanvas.height);
                var l = this.shapes.length;
                for (var i = 0; i < l; i++) {
                    var shape = this.shapes[i];
                    if (shape.x > this.width || shape.y > this.height ||
                            shape.x + shape.w < 0 || shape.y + shape.h < 0)
                        continue;
                    this.shapes[i].draw(this.ctx);
                }
                l = this.lines.length;
                for (i = 0; i < l; i++) {
                    this.lines[i].draw(this.pencilCtx);
                }
                if (this.selection !== null) {
                    if (this.selection.tipo() === "Shape") {                        
                        this.ctx.strokeStyle = "black";
                        this.ctx.lineWidth = this.selectionWidth;
                        var mySel = this.selection;
                        this.ctx.strokeRect(mySel.x * resizeFactor, mySel.y * resizeFactor, mySel.w, mySel.h);
                    }
                    else if (this.selection.tipo() === "Line") {                        
                        this.pencilCtx.fillStyle = "white";
                        this.pencilCtx.lineWidth = 1;
                        this.pencilCtx.strokeStyle = "black";
                        this.pencilCtx.beginPath();
                        var mySel = this.selection;
                        this.selection.draw(this.pencilCtx);
                        this.pencilCtx.stroke();
                        this.pencilCtx.beginPath();
                        this.pencilCtx.arc(mySel.beginX * resizeFactor, mySel.beginY * resizeFactor, 5, 2 * Math.PI, false);
                        this.pencilCtx.fill();
                        this.pencilCtx.stroke();
                        this.pencilCtx.beginPath();
                        this.pencilCtx.arc(mySel.endX * resizeFactor, mySel.endY * resizeFactor, 5, 2 * Math.PI, false);
                        this.pencilCtx.fill();
                        this.pencilCtx.stroke();
                    }
                }
                cs.drawSections(this.numberOfSections);
                this.latestNumberOfSections = this.numberOfSections;
                if (this.numberOfSections !== 0) {
                    for (var i = 0; i < this.titles.length; i++) {
                        this.titles[i].drawTitle(this.matrixCtx);
                    }
                }
                this.valid = true;
            }
        };
        CanvasState.prototype.drawSections = function (numberOfSections) {
            var titles = [];
            switch (numberOfSections) {
                case 0:
                    this.matrixCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                    break;
                case 2:
                    this.matrixCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                    this.matrixCtx.beginPath();
                    this.matrixCtx.strokeStyle = "black";
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.moveTo((postItCanvas.width / 2), 0);
                    this.matrixCtx.lineTo((postItCanvas.width / 2), postItCanvas.height);
                    this.matrixCtx.stroke();
                    if (this.latestNumberOfSections !== this.numberOfSections) {
                        var title1 = new Text("t1", "title1", (defaultCanvasWidth / 4), 10);
                        var title2 = new Text("t2", "title2", ((3 * defaultCanvasWidth) / 4), 10);
                        titles.push(title1);
                        titles.push(title2);
                        setTitlesState(titles);
                    }
                    break;
                case 4:
                    this.matrixCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.strokeStyle = "black";
                    this.matrixCtx.moveTo((postItCanvas.width / 2), 0);
                    this.matrixCtx.lineTo((postItCanvas.width / 2), postItCanvas.height);
                    this.matrixCtx.stroke();
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.moveTo(0, (postItCanvas.height / 2));
                    this.matrixCtx.lineTo(postItCanvas.width, (postItCanvas.height / 2));
                    this.matrixCtx.stroke();
                    if (this.latestNumberOfSections !== this.numberOfSections) {
                        var title1 = new Text("t1", "title1", (defaultCanvasWidth / 4), 10);
                        var title2 = new Text("t2", "title2", ((3 * defaultCanvasWidth) / 4), 10);
                        var title3 = new Text("t3", "title3", (defaultCanvasWidth / 4), (defaultCanvasHeight / 2) + 10);
                        var title4 = new Text("t4", "title4", ((3 * defaultCanvasWidth) / 4), (defaultCanvasHeight / 2) + 10);
                        titles.push(title1);
                        titles.push(title2);
                        titles.push(title3);
                        titles.push(title4);
                        setTitlesState(titles);
                    }
                    break;
                case 6:
                    this.matrixCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.strokeStyle = "black";
                    this.matrixCtx.moveTo((postItCanvas.width / 2), 0);
                    this.matrixCtx.lineTo((postItCanvas.width / 2), postItCanvas.height);
                    this.matrixCtx.stroke();
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.moveTo(0, (postItCanvas.height / 3));
                    this.matrixCtx.lineTo(postItCanvas.width, (postItCanvas.height / 3));
                    this.matrixCtx.stroke();
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.moveTo(0, ((2 * postItCanvas.height) / 3));
                    this.matrixCtx.lineTo(postItCanvas.width, ((2 * postItCanvas.height) / 3));
                    this.matrixCtx.stroke();
                    if (this.latestNumberOfSections !== this.numberOfSections) {
                        var title1 = new Text("t1", "title1", (defaultCanvasWidth / 4), 10);
                        var title2 = new Text("t2", "title2", ((3 * defaultCanvasWidth) / 4), 10);
                        var title3 = new Text("t3", "title3", (defaultCanvasWidth / 4), (defaultCanvasHeight / 3) + 10);
                        var title4 = new Text("t4", "title4", ((3 * defaultCanvasWidth) / 4), (defaultCanvasHeight / 3) + 10);
                        var title5 = new Text("t5", "title5", (defaultCanvasWidth / 4), (2 * (defaultCanvasHeight / 3)) + 10);
                        var title6 = new Text("t6", "title6", ((3 * defaultCanvasWidth) / 4), (2 * (defaultCanvasHeight / 3)) + 10);
                        titles.push(title1);
                        titles.push(title2);
                        titles.push(title3);
                        titles.push(title4);
                        titles.push(title5);
                        titles.push(title6);
                        setTitlesState(titles);
                    }
                    break;
                case 9:
                    this.matrixCtx.clearRect(0, 0, postItCanvas.width, postItCanvas.height);
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.strokeStyle = "black";
                    this.matrixCtx.moveTo((postItCanvas.width / 3), 0);
                    this.matrixCtx.lineTo((postItCanvas.width / 3), postItCanvas.height);
                    this.matrixCtx.stroke();
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.moveTo((2 * (postItCanvas.width / 3)), 0);
                    this.matrixCtx.lineTo((2 * (postItCanvas.width / 3)), postItCanvas.height);
                    this.matrixCtx.stroke();
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.moveTo(0, (postItCanvas.height / 3));
                    this.matrixCtx.lineTo(postItCanvas.width, (postItCanvas.height / 3));
                    this.matrixCtx.stroke();
                    this.matrixCtx.beginPath();
                    this.matrixCtx.lineWidth = 4;
                    this.matrixCtx.moveTo(0, ((2 * postItCanvas.height) / 3));
                    this.matrixCtx.lineTo(postItCanvas.width, ((2 * postItCanvas.height) / 3));
                    this.matrixCtx.stroke();
                    if (this.latestNumberOfSections !== this.numberOfSections) {
                        var title1 = new Text("t1", "title1", (defaultCanvasWidth / 6), 10);
                        var title2 = new Text("t2", "title2", ((defaultCanvasWidth) / 2), 10);
                        var title3 = new Text("t3", "title3", ((5 * defaultCanvasWidth) / 6), 10);
                        var title4 = new Text("t4", "title4", (defaultCanvasWidth / 6), (defaultCanvasHeight / 3) + 10);
                        var title5 = new Text("t5", "title5", ((defaultCanvasWidth) / 2), (defaultCanvasHeight / 3) + 10);
                        var title6 = new Text("t6", "title6", ((5 * defaultCanvasWidth) / 6), (defaultCanvasHeight / 3) + 10);
                        var title7 = new Text("t7", "title7", (defaultCanvasWidth / 6), (2 * (defaultCanvasHeight / 3)) + 10);
                        var title8 = new Text("t8", "title8", ((defaultCanvasWidth) / 2), (2 * (defaultCanvasHeight / 3)) + 10);
                        var title9 = new Text("t9", "title9", ((5 * defaultCanvasWidth) / 6), (2 * (defaultCanvasHeight / 3)) + 10);
                        titles.push(title1);
                        titles.push(title2);
                        titles.push(title3);
                        titles.push(title4);
                        titles.push(title5);
                        titles.push(title6);
                        titles.push(title7);
                        titles.push(title8);
                        titles.push(title9);
                        setTitlesState(titles);
                    }
                    break;
            }
        };
        CanvasState.prototype.drawDefaultTitles = function (n) {

        };
        CanvasState.prototype.getMouse = function (canvas, e) {
            var rect = this.canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        };
        function updateInternalSectionsState(string) {
            try {
                if (string !== undefined) {
                    var numberOfSections = JSON.parse(string);
                    cs.setNumberOfSections(numberOfSections);
                    cs.invalidate();
                }
            } catch (e) {
               // console.log(e);
            }
        }
        function updateInternalState(stringhificato) {
            try {
                if (stringhificato !== undefined) {
                    var newIdsValidShapes = stringhificato;
                    var parsed = JSON.parse(newIdsValidShapes);
                    var nuoveforme = [];
                    for (i = 0; i < parsed.length; i++) {
                        var idStr = JSON.stringify(parsed[i]);
                        var shapeStr = gapi.hangout.data.getValue(idStr);
                        var shapePar = JSON.parse(shapeStr);
                        var shape = new Shape(shapePar.id, shapePar.text, shapePar.x, shapePar.y, shapePar.w, shapePar.h, shapePar.ls, shapePar.ds, shapePar.fill, shapePar.au);
                        nuoveforme.push(shape);
                    }
                    cs.setIdShapes(parsed);
                    cs.setShapes(nuoveforme);
                    cs.invalidate();
                }
            } catch (e) {
               // console.log(e);
            }
        }
        function updateInternalLinesState(stringifiedValidLines) {
            try {
                if (stringifiedValidLines !== undefined) {
                    var parsedValidLines = JSON.parse(stringifiedValidLines);
                    var nuovelinee = [];
                    for (i = 0; i < parsedValidLines.length; i++) {
                        var idStr = JSON.stringify(parsedValidLines[i]);
                        var lineStr = gapi.hangout.data.getValue(idStr);
                        var linePar = JSON.parse(lineStr);
                        var line = new Line(linePar.id, linePar.beginX, linePar.beginY, linePar.endX, linePar.endY, linePar.color);
                        nuovelinee.push(line);
                    }
                    cs.setIdLines(parsedValidLines);
                    cs.setLines(nuovelinee);
                    cs.invalidate();
                }
            } catch (e) {
               // console.log(e);
            }
        }
        function updateInternalTitlesState(string) {
            try {
                if (string !== undefined) {
                    var parsedValidTitles = JSON.parse(string);
                    var nuoviTitoli = [];
                    for (i = 0; i < parsedValidTitles.length; i++) {
                        var id = parsedValidTitles[i];
                        var titleStr = gapi.hangout.data.getValue(id);
                        var titlePar = JSON.parse(titleStr);
                        var title = new Text(titlePar.id, titlePar.text, titlePar.x, titlePar.y);
                        nuoviTitoli.push(title);
                    }
                    cs.setIdTitles(parsedValidTitles);
                    cs.setTitles(nuoviTitoli);
                    cs.invalidate();
                }
            } catch (e) {
               // console.log(e);
            }
        }
        function getInfo() {
            var state = gapi.hangout.data.getState();
            var chiavi = gapi.hangout.data.getKeys();
            var ids = JSON.parse(state.validShapes);
            console.log("Queste sono tutte le chiavi presenti attualmente nell'oggetto stato: " + chiavi);
            console.log("Questo è l'oggetto stato completo: " + state);
            console.log("Questo è il valore in idAssignment: " + state.idassignment);
            var stateSize = roughSizeOfObject(state);
            console.log("Spazio totale occupato dall'oggetto Stato: ");
            console.log("circa " + stateSize + " bytes");
            var name = gapi.hangout.getLocalParticipant().person.displayName;
            var bool = gapi.hangout.getLocalParticipant().isBroadcaster;
            console.log("io sono il partecipante di nome: " + name);
            console.log("sono l'amministratore dell'hangout? " + bool);
            //var canvas = document.getElementById("postItCanvas");
            //var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
            //window.location.href = image;
            stackAndSave();
        }
        function stackAndSave() {
            var postItCanvas = document.getElementById("postItCanvas");
            var matrixCanvas = document.getElementById("matrixCanvas");
            var pencilCanvas = document.getElementById("pencilCanvas");
            var imageCanvas = document.getElementById("imageCanvas");
            var imageCtx = imageCanvas.getContext('2d');            
            imageCtx.clearRect (0, 0, defaultCanvasWidth * resizeFactor, defaultCanvasHeight * resizeFactor);
            imageCtx.drawImage(matrixCanvas, 0, 0);
            imageCtx.drawImage(pencilCanvas, 0, 0);
            imageCtx.drawImage(postItCanvas, 0, 0);
            var image = imageCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
            window.location.href = image;
        }
        function roughSizeOfObject(object) {
            var objectList = [];
            var stack = [object];
            var bytes = 0;
            while (stack.length) {
                var value = stack.pop();
                if (typeof value === 'boolean') {
                    bytes += 4;
                }
                else if (typeof value === 'string') {
                    bytes += value.length * 2;
                }
                else if (typeof value === 'number') {
                    bytes += 8;
                }
                else if (typeof value === 'object' && objectList.indexOf(value) === -1) {
                    objectList.push(value);
                    for (var i in value) {
                        stack.push(value[ i ]);
                    }
                }
            }
            return bytes;
        }
        function setTitlesState(titles) {            
            try {
                var idTitles = [];
                for (var i = 0; i < titles.length; i++) {                    
                    idTitles.push(titles[i].id);
                }                
                var validTitles = "validTitles";
                var obj = {};
                obj[validTitles] = JSON.stringify(idTitles);
                for (var j = 0; j < titles.length; j++) {
                    var id = titles[j].id;
                    var titleStr = JSON.stringify(titles[j]);
                    obj[id] = titleStr;
                }
                gapi.hangout.data.submitDelta(obj);
            } catch (e) {
                //console.log(e);
            }
        }
        function setTitleState(title) {
            try {
                var id = title.id;
                var titleStr = JSON.stringify(title);
                var idStr = JSON.stringify(id);
                var obj = {};
                obj[id] = titleStr;
                gapi.hangout.data.submitDelta(obj);
            } catch (e) {
                //console.log(e);
            }
        }
        function addLineToState(line, idLines) {
            try {
                var linea = line;
                var id = line.id;
                var lineaStr = JSON.stringify(linea);
                var idStr = JSON.stringify(id);
                var idLinesStr = JSON.stringify(idLines);
                var validLines = "validLines";
                var obj = {};
                obj[idStr] = lineaStr;
                obj[validLines] = idLinesStr;
                gapi.hangout.data.submitDelta(obj);
            } catch (e) {
                //console.log(e);
            }
        }
        function setLineState(line) {
            var linea = line;
            var id = line.id;
            var lineaStr = JSON.stringify(linea);            
            var idStr = JSON.stringify(id);
            var obj = {};
            obj[idStr] = lineaStr;
            gapi.hangout.data.submitDelta(obj);
        }
        function removeLineFromState(shape) {
            try {
                var linea = shape;
                var id = linea.id;
                var idsStr = gapi.hangout.data.getValue('validLines');
                var idsPar = JSON.parse(idsStr);
                var i = 0;
                var found = false;
                while ((i < idsPar.length) && !found) {
                    if (idsPar[i] === id) {
                        idsPar.splice(i, 1);
                        found = true;
                    }
                    i++;
                }
                var newIdsStr = JSON.stringify(idsPar);
                gapi.hangout.data.submitDelta({'validLines': newIdsStr}, [String(id)]);
            } catch (e) {
                //console.log(e);
            }
        }
        function addShapeToState(shape, idShapes) {
            try {
                var forma = shape;
                var id = forma.id;
                var formaStr = JSON.stringify(forma);
                var idStr = JSON.stringify(id);
                var idShapesStr = JSON.stringify(idShapes);
                var validShapes = "validShapes";
                var obj = {};
                obj[idStr] = formaStr;
                obj[validShapes] = idShapesStr;
                gapi.hangout.data.submitDelta(obj);
            } catch (e) {
                //console.log(e);
            }
        }
        function setShapeState(shape) {
            var forma = shape;
            var id = forma.id;
            var formaStr = JSON.stringify(forma);            
            var idStr = JSON.stringify(id);
            var obj = {};
            obj[idStr] = formaStr;
            gapi.hangout.data.submitDelta(obj);
        }
        function setShapePositionState(shape) {
            var forma = shape;
            var id = forma.id;
            var idStr = JSON.stringify(id);
            var shapeStr = gapi.hangout.data.getValue(idStr);
            var shapePar = JSON.parse(shapeStr);
            var updatedShape = new Shape(shapePar.id, shapePar.text, forma.x, forma.y, shapePar.w, shapePar.h, shapePar.ls, shapePar.ds, shapePar.fill, shapePar.au);
            setShapeState(updatedShape);
        }
        function setShapeLikesState(shape) {
            var forma = shape;
            var id = forma.id;
            var idStr = JSON.stringify(id);
            var shapeStr = gapi.hangout.data.getValue(idStr);
            var shapePar = JSON.parse(shapeStr);
            var updatedShape = new Shape(shapePar.id, shapePar.text, shapePar.x, shapePar.y, shapePar.w, shapePar.h, forma.ls, forma.ds, shapePar.fill, shapePar.au);
            setShapeState(updatedShape);
        }
        function removeShapeFromState(shape) {
            try {
                var forma = shape;
                var id = forma.id;
                var idsStr = gapi.hangout.data.getValue('validShapes');
                var idsPar = JSON.parse(idsStr);
                var i = 0;
                var found = false;
                while ((i < idsPar.length) && !found) {
                    if (idsPar[i] === id) {
                        idsPar.splice(i, 1);
                        found = true;
                    }
                    i++;
                }
                var newIdsStr = JSON.stringify(idsPar);
                gapi.hangout.data.submitDelta({'validShapes': newIdsStr}, [String(id)]);
            } catch (e) {
                //console.log(e);
            }
        }
        function updateInternalCanvasStateSize(string) {
            try {
                if (string !== undefined) {
                    resizeFactor = parseFloat(string);
                    if (resizeFactor !== latestResizeFactor) {
                        document.getElementById("shadowCanvas").width = String(defaultCanvasWidth * resizeFactor);
                        document.getElementById("shadowCanvas").height = String(defaultCanvasHeight * resizeFactor);
                        document.getElementById("postItCanvas").width = String(defaultCanvasWidth * resizeFactor);
                        document.getElementById("postItCanvas").height = String(defaultCanvasHeight * resizeFactor);
                        document.getElementById("pencilCanvas").width = String(defaultCanvasWidth * resizeFactor);
                        document.getElementById("pencilCanvas").height = String(defaultCanvasHeight * resizeFactor);
                        document.getElementById("matrixCanvas").width = String(defaultCanvasWidth * resizeFactor);
                        document.getElementById("matrixCanvas").height = String(defaultCanvasHeight * resizeFactor);
                        document.getElementById("imageCanvas").width = String(defaultCanvasWidth * resizeFactor);
                        document.getElementById("imageCanvas").height = String(defaultCanvasHeight * resizeFactor);                        
                        cs.invalidate();
                        latestResizeFactor = resizeFactor;
                    }
                }
            } catch (e) {
                //console.log(e);
            }
        }
        gapi.hangout.data.onStateChanged.add(function(event) {
            updateInternalState(event.state.validShapes);
            updateInternalLinesState(event.state.validLines);
            updateInternalCanvasStateSize(event.state.size);
            updateInternalSectionsState(event.state.sections);
            updateInternalTitlesState(event.state.validTitles);
            updateInternalForms(event.state.Wforms);
            if (window.formAdded != true) {
                n++;
                window.formAdded = false;
            }
            if (n > 5) {
                document.getElementById("undo").disabled = true;
            }
            window.formAdded = false;
            console.log(event.state.tableEnded);
            console.log(event.tableEnded)
            if (event.state.tableEnded === "true") {
               endTable();
            }
        });

      
  

;


function saveImage()  {
	     console.log("saving Image");
             var postItCanvas = document.getElementById("postItCanvas");
            var matrixCanvas = document.getElementById("matrixCanvas");
            var pencilCanvas = document.getElementById("pencilCanvas");
            var imageCanvas = document.getElementById("imageCanvas");
            var imageCtx = imageCanvas.getContext('2d');       
	     console.log("cia");     
            imageCtx.clearRect (0, 0, defaultCanvasWidth * resizeFactor, defaultCanvasHeight * resizeFactor);
            imageCtx.fillStyle = "white";
            imageCtx.fillRect(0,0,defaultCanvasWidth * resizeFactor,defaultCanvasHeight * resizeFactor);
            imageCtx.drawImage(matrixCanvas, 0, 0);
            imageCtx.drawImage(pencilCanvas, 0, 0);
            imageCtx.drawImage(postItCanvas, 0, 0);
            // l'immagine per il server:
	    console.log("lalala");
            var image = imageCanvas.toDataURL("image/png");
       
	   
	
	    console.log("cia");
            uploadDriveFile(image);
        
}

function sendImage(image) {
        if (image.length <= 1000) {
          var imageX = image;
        } else {
          var imageX = image.substring(0,1000);
          setTimeout(function () {
             sendImage(image.substring(1000));
          },2000);
        }
        var link = "https://script.google.com/macros/s/AKfycbw7YF12JVz3RdqrpMHUte5tYAL5dzidpIISV3VIqBGkRxT4IWk/exec?prefix=saveImg";
            //alert(gapi.hangout.data.getValue("cafeId"));
            $.ajax({
                type: "POST",
                url: link,
                data: {callback: "?",image:true, link: imageX, containerId: gapi.hangout.data.getValue("cafeId")},
                dataType: "script"
            }).done(function(data) {
                console.log(data); //data returned : UNDEFINED
            });
}



        function getParameters() {
            var vars = {};
            var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
                vars[key] = value;
            });
            return vars;
        }

        function addHangout(code) {
            var vars = {};
            var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m, key, value) {
                vars[key] = value;
            });
            var gd = vars["gd"]; 
            console.log(vars);
            //var gd = code;
            if (typeof gd != "undefined") {
                var array = gd.split('e');
                var obj = {};
                obj["cafeId"]=array[0];
		obj["host"]=array[1];
                window.formAdded = true;
                gapi.hangout.data.submitDelta(obj);  
                var hangout_id = gapi.hangout.getHangoutUrl();
                var url_video = gapi.hangout.onair.getYouTubeLiveId();
                var link = "https://script.google.com/macros/s/AKfycbw7YF12JVz3RdqrpMHUte5tYAL5dzidpIISV3VIqBGkRxT4IWk/exec?prefix=saveElem";
                $.ajax({
                    type: "GET",
                    url: link,
                    data: {urlHangout: hangout_id, linkVideo: url_video, containerId: array[0],host:array[1],hangout:true},
                    dataType: "script"
                }).done(function(data) {
                    console.log(data); //data returned : UNDEFINED
                });
            }
        }

        function saveElem(data) {
            console.log(data);
        }

        $('#createFormButton').on('click', function(e) {
            e.preventDefault();
            var $myForm = $('#newCreateForm');
            if (!$myForm[0].checkValidity()) {
                $('#formSubmit').click();
            }
            else {
                $('#createFormButton').hide();
                $('#closeFormModal').hide();
                var formData = $myForm.serialize(); //get all data from form
                $('#newCreateForm').hide(500);
                console.log($myForm[0][0].value);
                var fileSelectForm = $('#newQuestionForm');
                var fileSelectButton = $('#createQuestionButton');
                var fileConcludeButton = $('#endQuestionButton')
                fileSelectForm.css('visibility', 'visible').hide().fadeIn().removeClass('hidden');
                fileSelectButton.css('visibility', 'visible').hide().fadeIn().removeClass('hidden');
                fileConcludeButton.css('visibility', 'visible').hide().fadeIn().removeClass('hidden');
                $('#closeFormButton').addClass('hidden');
               
                var link = "https://script.google.com/macros/s/AKfycbw7YF12JVz3RdqrpMHUte5tYAL5dzidpIISV3VIqBGkRxT4IWk/exec?prefix=saveForm";
                $.ajax({
                    type: "GET",
                    url: link,
                    data: {callback: "?", title: $myForm[0][0].value, containerId: gapi.hangout.data.getValue("cafeId") ,form: true, create: true,host:gapi.hangout.data.getValue("host")},
                    dataType: "script"
                }).done(function(data) {
                    console.log(data); //data returned : UNDEFINED
                });
            }
        });

        $('#createQuestionButton').on('click', function(e) {
            e.preventDefault();
            var $myForm = $('#newQuestionForm');
            if (!$myForm[0].checkValidity()) {
                $('#questionSubmit').click();
            }
            else {

                var formData = $myForm.serialize(); //get all data from form


                array = "yes;no;maybe";
                console.log(array);
                console.log($myForm[0]);
                var link = "https://script.google.com/macros/s/AKfycbw7YF12JVz3RdqrpMHUte5tYAL5dzidpIISV3VIqBGkRxT4IWk/exec?prefix=saveQuestion";
                $.ajax({
                    type: "GET",
                    url: link,
                    data: {callback: "?", elemId: $myForm[0][0].value, question: $myForm[0][2].value, type: $myForm[0][1].value, choises: $myForm[0][3].value, form: true, createQuestion: true},
                    dataType: "script"
                }).done(function(data) {
                    console.log(data); //data returned : UNDEFINED
                });
                $('#newQuestionForm')[0].reset();
                $('#Checkbox').css('visibility', 'visible').hide().removeClass('hidden');
                $("#Checkbox").show();
            }
        });

        $("#questionSetting").change(function() {
            var $myForm = $('#newQuestionForm');
            if ($myForm[0][1].value == "Open Awnser") {
                $("#Checkbox").addClass("hidden");
                $("#Checkbox").hide();
            } else {
                $('#Checkbox').css('visibility', 'visible').hide().removeClass('hidden');
                $("#Checkbox").show();
            }
        });

        $('#endQuestionButton').on('click', function(e) {
            $('#newCreateForm')[0].reset();
            $('#newQuestionForm')[0].reset();
            $('#newQuestionForm').addClass('hidden');
            $('#createQuestionButton').addClass('hidden');
            $('#endQuestionButton').addClass('hidden');
            $('#endQuestionButton').hide();
            $('#createQuestionButton').hide();
            $('#newCreateForm').show();
            $('#newQuestionForm').hide();
            $('#createFormButton').show();
            $('#closeFormButton').css('visibility', 'visible').hide().removeClass('hidden');
            $('#closeFormButton').show();
            $('#Checkbox').css('visibility', 'visible').hide().removeClass('hidden');
            $("#Checkbox").show();
        });

        function saveQuestion(data) {
            console.log(data);
            $('#newQuestionForm')[0].reset();


        }




        function saveForm(data) {
            console.log(data);
            var modalDiv = $('#newFormModal');
            modalDiv.find('input[name=formId]').val(data.elemId);
            saveStateForms(data.elemId, data.link);

        }

        function saveStateForms(elemId, link) {
            var id = elemId;
            var link = link;
            formIds.push(elemId);
            var obj = {};
            obj["Wforms"] = JSON.stringify(formIds);
            obj[elemId] = link;
            window.formAdded = true;
            gapi.hangout.data.submitDelta(obj);

        }

        function updateInternalForms(forms) {
            try {
                if (forms !== undefined) {
                    var parsed = JSON.parse(forms);
                    console.log(forms);
                    $('#forms').fadeOut();
                    $('#formContainer').prepend('<div id="forms" style="width:500;height:450;border:solid"></div>');
                    for (i = 0; i < parsed.length; i++) {
                        var id = parsed[i];
                        var link = gapi.hangout.data.getValue(id);
                        console.log("new form: " + id + "," + link);
                        $('#forms').append('<button type="button" data-toggle="modal" data-target="" id="' + id + '" class="canvasbutton comp_f">Compile Form</button> </div> <button type="button" data-toggle="modal" data-target="" id="' + id + '" class="canvasbutton view_r">View Results</button> </div>');

                    }

                }
            } catch (e) {
                console.log(e);
            }
        }

        function ViewResult(event) {
            var id = $(event.target).attr("id");
            var link = "https://script.google.com/macros/s/AKfycbw7YF12JVz3RdqrpMHUte5tYAL5dzidpIISV3VIqBGkRxT4IWk/exec?prefix=showRes";
            $.ajax({
                type: "GET",
                url: link,
                data: {callback: "?", elemId: id,form:true, showResults: true},
                dataType: "script"
            }).done(function(data) {
                console.log(data); //data returned : UNDEFINED
            });
        }

        function CompileForm(event) {
            var id = $(event.target).attr('id');
            var modalDiv = $('#compileFormModal');
            var address= gapi.hangout.data.getValue(id);
            $('#compiles').fadeOut();
            $('#embedForm').prepend('<div id="compiles"></div>');
            $('#compiles').prepend(address);
            modalDiv.modal('show');

        }

        $('#formContainer').on('click', 'button.comp_f', CompileForm);
        $('#formContainer').on('click', 'button.view_r', ViewResult);

     

        function showRes(data) {
            var modalDiv = $('#resultFormModal');
            console.log(data);
            $('#results').fadeOut();
            $('#resultBody').prepend('<div id="results" class="row"></div>');
            if (data.size != 0){
            for (var i=0; i<data.size; i++){
                var title = data.questions[i][0];
                $('#results').append('<div id="question'+i+'" ><b>'+title+'</div>');
                for (var j=0; j< data.results[i].length; j++){
                    var scaledResult = ((data.results[i][j]*100)/(data.size));
                    console.log(data.results[i][j]);
                    console.log(scaledResult);
                    $('#question'+i).append('<div><i>'+j+'-'+data.questions[i][j+1]+'</i> '+ scaledResult+'/100% </div>');
                 
                }
           }
            
        }
        modalDiv.modal('show');
      }

      function saveImg(data){
        console.log(data);
      }

      document.getElementById('download').addEventListener('click', function() {
          downloadCanvas(this, 'canvas', 'whiteboard.png');
       }, false);

       document.getElementById('end').addEventListener('click', function() {
            console.log("Ending");  
            var obj = {};
            obj["tableEnded"] = "true";
            gapi.hangout.data.submitDelta(obj);
       }, false);

      function downloadCanvas(link, canvasId, filename){
             var postItCanvas = document.getElementById("postItCanvas");
            var matrixCanvas = document.getElementById("matrixCanvas");
            var pencilCanvas = document.getElementById("pencilCanvas");
            var imageCanvas = document.getElementById("imageCanvas");
            var imageCtx = imageCanvas.getContext('2d');            
            imageCtx.clearRect (0, 0, defaultCanvasWidth * resizeFactor, defaultCanvasHeight * resizeFactor);
            imageCtx.drawImage(matrixCanvas, 0, 0);
            imageCtx.drawImage(pencilCanvas, 0, 0);
            imageCtx.drawImage(postItCanvas, 0, 0);
            // l'immagine per il server:
             var image = imageCanvas.toDataURL("image/png");
             link.href = image;
             link.download = filename;  
            
          
      }

      function endAction(data){
         console.log(data.parameter);
      }

     $('#codeButton').on('click',function(e){
          $('#codeModal').modal('hide');
          var code = $('#codeForm')[0][0].value;
          addHangout(code);  
     }); 

     function endTable(){
         $('#table').fadeOut();
         $('#controls').fadeOut();
         $('#body').prepend('<div style="text-align:center;background-color:white;width:800;height:100">This table is ended. Please exit.</div>');
               var link = "https://script.google.com/macros/s/AKfycbw7YF12JVz3RdqrpMHUte5tYAL5dzidpIISV3VIqBGkRxT4IWk/exec?prefix=endAction";
                $.ajax({
                    type: "GET",
                    url: link,
                    data: {callback: "?", containerId: gapi.hangout.data.getValue("cafeId") ,host:gapi.hangout.data.getValue("host"),end:true},
                    dataType: "script"
                }).done(function(data) {
                    console.log(data); //data returned : UNDEFINED
                });
            var postItCanvas = document.getElementById("postItCanvas");
            var matrixCanvas = document.getElementById("matrixCanvas");
            var pencilCanvas = document.getElementById("pencilCanvas");
            var imageCanvas = document.getElementById("imageCanvas");
            var imageCtx = imageCanvas.getContext('2d');            
            imageCtx.clearRect (0, 0, defaultCanvasWidth * resizeFactor, defaultCanvasHeight * resizeFactor);
            imageCtx.fillStyle = "white";
            imageCtx.fillRect(0,0,defaultCanvasWidth * resizeFactor,defaultCanvasHeight * resizeFactor);
            imageCtx.drawImage(matrixCanvas, 0, 0);
            imageCtx.drawImage(pencilCanvas, 0, 0);
            imageCtx.drawImage(postItCanvas, 0, 0);
         var image = imageCanvas.toDataURL("image/png");
      
           saveImage();
      }

      function replaceContentInContainer(matchClass, content) {
        var elems = document.getElementsByTagName('*'), i;
        for (i in elems) {
        if((' ' + elems[i].className + ' ').indexOf(' ' + matchClass + ' ')
                > -1) {
            elems[i].innerHTML = content;
        }
    }
}



var CLIENT_ID = '978963900818-4133h6nkqhmo1i0grst58665ifn7sp61.apps.googleusercontent.com';
var SCOPES =  [
          'https://www.googleapis.com/auth/drive.file',
          'https://www.googleapis.com/auth/drive',
           'https://www.googleapis.com/auth/drive.appdata'
        ];


/**
 * Called when the client library is loaded to start the auth flow.
 */


/**
 * Check if the current user has authorized the application.
 */
function checkAuth() {
    console.log("BLA2");
    gapi.auth.authorize(
            {'client_id': CLIENT_ID, 'scope': SCOPES.join(' '), 'immediate': true},
    handleAuthResult);
}

/**
 * Called when authorization server replies.
 *
 * @param {Object} authResult Authorization result.
 */
function handleAuthResult(authResult) {
    console.log(authResult);
 
}

/**
 * Start the file upload.
 *
 * @param {Object} evt Arguments from the file selector.
 */
function uploadDriveFile(file) {
    console.log("uploading Image");
    gapi.client.load('drive', 'v2', function() {
       
        console.log(file);
        insertFile(file, function(file) {
            console.log(file);
            var iconLink = file.iconLink;
            var webLink = file.webContentLink;
            insertPermission(file.id,null,"anyone","reader");
            console.log(iconLink);
            console.log(webLink);
             var link = "https://script.google.com/macros/s/AKfycbw7YF12JVz3RdqrpMHUte5tYAL5dzidpIISV3VIqBGkRxT4IWk/exec?prefix=saveImg";
            //alert(gapi.hangout.data.getValue("cafeId"));
            $.ajax({
                type: "POST",
                url: link,
                data: {callback: "?",image:true, id: file.id, iconLink:iconLink,webLink:webLink, containerId: gapi.hangout.data.getValue("cafeId"),host:gapi.hangout.data.getValue("host")},
                dataType: "script"
            }).done(function(data) {
                console.log(data); //data returned : UNDEFINED
            });
        });
    });
}

function insertPermission(fileId, value, type, role) {
    var body = {
        'value': value,
        'type': type,
        'role': role
    };
    var request = gapi.client.drive.permissions.insert({
        'fileId': fileId,
        'resource': body
    });
    request.execute(function(resp) {
    });
}

/**
 * Insert new file.
 *
 * @param {File} fileData File object to read data from.
 * @param {Function} callback Function to call when the request is complete.
 */
function insertFile(fileData, callback) {
        
         bound = "========",
        meta = {
          "title": "whiteboard.png",
          "mimeType": "image/png",
          "description": "This image is created by canvas"
        },
        multiparts = [];

        fileData = fileData.split(',')[1];
    
    multiparts = [];
    multiparts.push('--' + bound);
    multiparts.push('Content-Type: application/json');
    multiparts.push('');
    multiparts.push(JSON.stringify(meta));
    multiparts.push('--' + bound);
    multiparts.push('Content-Type: image/png');
    multiparts.push('Content-Transfer-Encoding: base64');
    multiparts.push('');
    multiparts.push(fileData);
    multiparts.push('--' + bound + '--');
    multiparts.join("\r\n");
         var request = gapi.client.request({
            'path': '/upload/drive/v2/files',
            'method': 'POST',
            'params': {'uploadType': 'multipart'},
            'headers': {
                'Content-Type': 'multipart/mixed; boundary="' + bound + '"'
            },
            'body': multiparts.join("\r\n")});
        if (!callback) {
            callback = function(file) {
                console.log(file)
            };
        }

        request.execute(callback);
    
}

function dataURItoBlob(dataURI) {
    // convert base64/URLEncoded data component to raw binary data held in a string
    var byteString;
    if (dataURI.split(',')[0].indexOf('base64') >= 0)
        byteString = atob(dataURI.split(',')[1]);
    else
        byteString = unescape(dataURI.split(',')[1]);

    // separate out the mime component
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

    // write the bytes of the string to a typed array
    var ia = new Uint8Array(byteString.length);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }

    return new Blob([ia], {type:mimeString});
}

    </script>
</body>
